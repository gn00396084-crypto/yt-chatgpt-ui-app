<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÊïÖ‰∫ãË™™Èü≥Ê®ÇÔΩúÊúÄÊñ∞ÂΩ±Áâá</title>
  <style>
    :root { --bg:#f7f7fb; --text:#111; --muted:rgba(0,0,0,.65); --border:rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang TC","Noto Sans TC",sans-serif; background:var(--bg); color:var(--text); }

    header{
      position: sticky; top: 0; z-index: 20;
      background: rgba(247,247,251,.82);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 14px 16px; }
    .row-top{ display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .title{ font-weight: 800; letter-spacing:.2px; display:flex; gap:10px; align-items:center; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .nav a{ color: var(--text); text-decoration:none; padding:8px 10px; border-radius:10px; }
    .nav a:hover{ background: rgba(0,0,0,.06); }
    .nav a.active{ background: rgba(0,0,0,.06); }
    .toolbar{ display:flex; gap:10px; align-items:center; margin-top: 10px; }
    .btn{ border:1px solid var(--border); background:#fff; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700; }
    .btn:hover{ background: rgba(0,0,0,.04); }
    .pill{ font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff; color:var(--muted); }
    .hint{ font-size:12px; color: var(--muted); }

    /* ===== Horizontal Row ===== */
    .row-wrap{ position: relative; max-width: 1100px; margin: 18px auto 8px; padding: 0 16px; }
    .row{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(240px, 320px);
      gap: 16px;
      overflow-x: auto;
      padding: 6px 6px 12px;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .row::-webkit-scrollbar{ display:none; }

    .row-nav{
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 42px; height: 42px; border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      cursor: pointer; font-size: 22px; font-weight: 800;
      display:flex; align-items:center; justify-content:center;
      z-index: 5; user-select:none;
    }
    .row-nav:hover{ background: rgba(255,255,255,1); }
    .row-nav.left{ left: 6px; }
    .row-nav.right{ right: 6px; }

    .row-wrap:before, .row-wrap:after{
      content:""; position:absolute; top:0; bottom:0; width: 40px; pointer-events:none; z-index:4;
    }
    .row-wrap:before{
      left: 16px;
      background: linear-gradient(to right, rgba(247,247,251,1), rgba(247,247,251,0));
    }
    .row-wrap:after{
      right: 16px;
      background: linear-gradient(to left, rgba(247,247,251,1), rgba(247,247,251,0));
    }

    .g-card{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:#eee;
      aspect-ratio: 16 / 9;
      cursor:pointer;
      scroll-snap-align: start;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }
    .g-card img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transition: transform .35s ease;
      transform: scale(1.01);
    }
    .g-card:hover img{ transform: scale(1.06); }

    .g-overlay{
      position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(0,0,0,.0), rgba(0,0,0,.62));
      opacity:0; transition: opacity .2s ease;
      display:flex; align-items:flex-end; padding:12px;
    }
    .g-card:hover .g-overlay{ opacity:1; }
    .g-title{
      color:#fff; font-size:13px; line-height:1.3; font-weight:700;
      text-shadow: 0 2px 10px rgba(0,0,0,.45);
    }
    .g-play{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .g-play span{
      width:52px; height:52px; border-radius:50%;
      background: rgba(0,0,0,.55);
      color:#fff; font-size:22px;
      display:flex; align-items:center; justify-content:center;
      backdrop-filter: blur(6px);
    }

    .empty{
      max-width: 1100px;
      margin: 10px auto 24px;
      padding: 0 16px;
      color: var(--muted);
      white-space: pre-wrap;
    }

    /* ===== Modal ===== */
    body.modal-open { overflow: hidden; }
    .yt-modal{ position: fixed; inset: 0; display: none; z-index: 9999; }
    .yt-modal.is-open{ display:block; }
    .yt-modal__backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.6); }
    .yt-modal__panel{
      position: relative;
      width: min(980px, calc(100vw - 24px));
      margin: 6vh auto 0;
      background: #111;
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .yt-modal__close{
      position:absolute; top: 10px; right: 10px;
      width: 36px; height: 36px;
      border: 0; border-radius: 10px;
      background: rgba(255,255,255,.12);
      color: #fff; cursor: pointer; font-size: 18px; z-index: 2;
    }
    .yt-modal__close:hover{ background: rgba(255,255,255,.18); }
    .yt-modal__ratio{ position: relative; width: 100%; padding-top: 56.25%; }
    .yt-modal__ratio iframe{ position: absolute; inset: 0; width: 100%; height: 100%; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row-top">
      <div class="title">üéß ÊïÖ‰∫ãË™™Èü≥Ê®Ç <span class="pill">ÊúÄÊñ∞ÂΩ±Áâá</span></div>
      <div class="nav">
        <a href="/ui/videos" class="active">üè† È¶ñÈ†Å</a>
        <a href="/ui/search">üîé ÂéªÊêúÂ∞ã</a>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="loadVideos()">ÈáçÊñ∞ËºâÂÖ•</button>
      <span id="count" class="pill">‚Äî</span>
      <span class="hint">ÊãñÂãï/ÊªæËº™Ê©´ÂêëÊªëÂãïÔºåÈªûÂ∞ÅÈù¢ ‚ñ∂ Êí≠Êîæ</span>
    </div>
  </div>
</header>

<div class="row-wrap">
  <button class="row-nav left" aria-label="Prev" onclick="scrollRow(-1)">‚Äπ</button>
  <div id="videoRow" class="row"></div>
  <button class="row-nav right" aria-label="Next" onclick="scrollRow(1)">‚Ä∫</button>
</div>

<div id="empty" class="empty" style="display:none;"></div>

<!-- Modal -->
<div id="ytModal" class="yt-modal" aria-hidden="true">
  <div class="yt-modal__backdrop" onclick="closeYtModal()"></div>
  <div class="yt-modal__panel" role="dialog" aria-modal="true" aria-label="YouTube player">
    <button class="yt-modal__close" onclick="closeYtModal()" aria-label="Close">‚úï</button>
    <div class="yt-modal__ratio">
      <iframe id="ytFrame" title="YouTube video player" frameborder="0"
        allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
    </div>
  </div>
</div>

<script>
  const rowEl   = document.getElementById("videoRow");
  const emptyEl = document.getElementById("empty");
  const countEl = document.getElementById("count");
  const YT_MODAL = document.getElementById("ytModal");
  const YT_FRAME = document.getElementById("ytFrame");

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function openYtModal(videoId) {
    if (!videoId || String(videoId).length !== 11) {
      alert("Invalid videoId: " + videoId);
      return;
    }
    YT_FRAME.src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(videoId)}?autoplay=1&rel=0&modestbranding=1`;
    YT_MODAL.classList.add("is-open");
    YT_MODAL.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  }

  function closeYtModal() {
    YT_MODAL.classList.remove("is-open");
    YT_MODAL.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
    YT_FRAME.src = "";
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && YT_MODAL.classList.contains("is-open")) closeYtModal();
  });

  function renderRow(items){
    rowEl.innerHTML = items.map(v => {
      const vid = v.videoId;
      const title = escapeHtml(v.title || "(no title)");
      const thumb = v.thumbnailUrl || "";
      return `
        <div class="g-card" onclick="openYtModal('${vid}')">
          <img src="${thumb}" alt="${title}">
          <div class="g-play"><span>‚ñ∂</span></div>
          <div class="g-overlay"><div class="g-title">${title}</div></div>
        </div>
      `;
    }).join("");
  }

  function scrollRow(dir){
    const cardW = rowEl.firstElementChild?.getBoundingClientRect().width || 280;
    rowEl.scrollBy({ left: dir * (cardW + 16) * 1.2, behavior: "smooth" });
  }

  async function loadVideos(){
    emptyEl.style.display = "none";
    emptyEl.textContent = "";
    rowEl.innerHTML = "";
    countEl.textContent = "Loading‚Ä¶";

    const started = Date.now();
    const timer = setInterval(() => {
      const s = Math.floor((Date.now() - started) / 1000);
      countEl.textContent = `Loading‚Ä¶ ${s}s`;
    }, 500);

    try {
      const res = await fetch("/api/videos", { cache:"no-store" });
      const text = await res.text();

      if (!res.ok) {
        clearInterval(timer);
        countEl.textContent = `Error ${res.status}`;
        emptyEl.style.display = "block";
        emptyEl.textContent = `API /api/videos failed (${res.status})\n\n${text.slice(0, 1200)}`;
        return;
      }

      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        clearInterval(timer);
        countEl.textContent = "Bad JSON";
        emptyEl.style.display = "block";
        emptyEl.textContent =
          `JSON parse error: ${String(e)}\n\n` +
          `First 800 chars:\n${text.slice(0, 800)}\n\n` +
          `Last 800 chars:\n${text.slice(-800)}`;
        return;
      }

      const items = (data?.items || []).filter(x => x?.videoId);
      clearInterval(timer);
      countEl.textContent = `${items.length} videos`;
      renderRow(items);

    } catch (e) {
      clearInterval(timer);
      countEl.textContent = "Fetch Error";
      emptyEl.style.display = "block";
      emptyEl.textContent = `Failed to fetch /api/videos:\n${String(e)}`;
    }
  }

  // Desktop: wheel -> horizontal scroll (nice)
  rowEl.addEventListener("wheel", (e) => {
    if (e.shiftKey) return;
    if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
      e.preventDefault();
      rowEl.scrollBy({ left: e.deltaY, behavior: "auto" });
    }
  }, { passive: false });

  loadVideos();
</script>
</body>
</html>
