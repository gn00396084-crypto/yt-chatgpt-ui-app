<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Videos</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --text:#111; --muted:rgba(0,0,0,.65); --border:rgba(0,0,0,.08); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang TC","Noto Sans TC",sans-serif; background:var(--bg); color:var(--text); }
    header { position: sticky; top: 0; z-index: 20; background: rgba(247,247,251,.8); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px 16px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .title { font-weight: 750; letter-spacing:.2px; }
    .nav a { color: var(--text); text-decoration:none; padding:8px 10px; border-radius:10px; }
    .nav a:hover { background: rgba(0,0,0,.06); }
    .pill { font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background: #fff; color: var(--muted); }

    .toolbar { display:flex; gap:10px; align-items:center; margin-top: 10px; }
    .btn {
      border:1px solid var(--border); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:650;
    }
    .btn:hover { background: rgba(0,0,0,.04); }
    .hint { font-size:12px; color: var(--muted); }

    .vgrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
      padding: 18px 16px 24px;
      max-width: 1100px;
      margin: 0 auto;
    }
    .vcard{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background:var(--card);
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }
    .vthumb{
      position:relative;
      aspect-ratio: 16 / 9;
      background:#eee;
      overflow:hidden;
    }
    .vthumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
      transform: scale(1.01);
    }
    .vplay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: linear-gradient(to bottom, rgba(0,0,0,.0), rgba(0,0,0,.25));
      border:0;
      cursor:pointer;
    }
    .vplay span{
      width:56px; height:56px;
      border-radius: 18px;
      background: rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size: 22px;
      backdrop-filter: blur(6px);
    }
    .vmeta{ padding:10px 12px 12px; }
    .vtitle{ font-weight: 700; font-size: 14px; line-height: 1.35; }
    .vsub{ opacity:.75; font-size: 12px; margin-top: 6px; display:flex; justify-content:space-between; gap:10px; }
    .vsub .date { opacity:.7; white-space:nowrap; }
    .empty { max-width: 1100px; margin: 18px auto; padding: 0 16px; color: var(--muted); }
    .footer { max-width:1100px; margin:0 auto; padding: 0 16px 24px; color: var(--muted); font-size:12px; }

    /* ===== Modal ===== */
    body.modal-open { overflow: hidden; }
    .yt-modal { position: fixed; inset: 0; display: none; z-index: 9999; }
    .yt-modal.is-open { display: block; }
    .yt-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.6); }
    .yt-modal__panel {
      position: relative;
      width: min(980px, calc(100vw - 24px));
      margin: 6vh auto 0;
      background: #111;
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .yt-modal__close {
      position: absolute; top: 10px; right: 10px;
      width: 36px; height: 36px;
      border: 0; border-radius: 10px;
      background: rgba(255,255,255,.12);
      color: #fff; cursor: pointer;
      font-size: 18px;
      z-index: 2;
    }
    .yt-modal__close:hover { background: rgba(255,255,255,.18); }
    .yt-modal__ratio { position: relative; width: 100%; padding-top: 56.25%; }
    .yt-modal__ratio iframe { position: absolute; inset: 0; width: 100%; height: 100%; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="title">ðŸ“º Videos</div>
      <div class="nav">
        <a href="/ui/search">Search</a>
        <a href="/ui/videos" style="background:rgba(0,0,0,.06);">Videos</a>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn" onclick="loadVideos()">Reload</button>
      <span id="count" class="pill">â€”</span>
      <span class="hint">é»žç¸®åœ– â–¶ æ’­æ”¾ï¼ˆModalï¼‰</span>
    </div>
  </div>
</header>

<div id="videoGrid" class="vgrid"></div>
<div id="empty" class="empty" style="display:none;"></div>

<div class="footer">
  Data source: <code>/api/videos</code> (forward to Cloudflare Worker <code>/my-channel/videos</code>).
</div>

<!-- ===== Modal Video Player (YouTube) ===== -->
<div id="ytModal" class="yt-modal" aria-hidden="true">
  <div class="yt-modal__backdrop" onclick="closeYtModal()"></div>
  <div class="yt-modal__panel" role="dialog" aria-modal="true" aria-label="YouTube player">
    <button class="yt-modal__close" onclick="closeYtModal()" aria-label="Close">âœ•</button>
    <div class="yt-modal__ratio">
      <iframe
        id="ytFrame"
        title="YouTube video player"
        frameborder="0"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen
      ></iframe>
    </div>
  </div>
</div>

<script>
  const grid = document.getElementById("videoGrid");
  const emptyEl = document.getElementById("empty");
  const countEl = document.getElementById("count");
  const YT_MODAL = document.getElementById("ytModal");
  const YT_FRAME = document.getElementById("ytFrame");

  function openYtModal(videoId) {
    YT_FRAME.src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(videoId)}?autoplay=1&rel=0&modestbranding=1`;
    YT_MODAL.classList.add("is-open");
    YT_MODAL.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  }
  function closeYtModal() {
    YT_MODAL.classList.remove("is-open");
    YT_MODAL.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
    YT_FRAME.src = "";
  }
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && YT_MODAL.classList.contains("is-open")) closeYtModal();
  });

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function fmtDate(s){
    if (!s) return "";
    try { return new Date(s).toISOString().slice(0,10); } catch { return ""; }
  }

  async function loadVideos() {
    emptyEl.style.display = "none";
    grid.innerHTML = "";
    countEl.textContent = "Loadingâ€¦";

    const res = await fetch("/api/videos", { cache: "no-store" });
    if (!res.ok) {
      countEl.textContent = "Error";
      emptyEl.style.display = "block";
      emptyEl.textContent = `Failed to load: /api/videos (${res.status})`;
      return;
    }
    const data = await res.json();
    const items = data?.items || data?.videos || [];
    render(items);
  }

  function render(items) {
    if (!items.length) {
      countEl.textContent = "0";
      emptyEl.style.display = "block";
      emptyEl.textContent = "No videos.";
      return;
    }
    countEl.textContent = `${items.length} videos`;

    grid.innerHTML = items.map(v => {
      const vid = v.videoId || v.id?.videoId || v.id;
      const title = escapeHtml(v.title || v.snippet?.title || "(no title)");
      const ch = escapeHtml(v.channelTitle || v.snippet?.channelTitle || "");
      const dt = fmtDate(v.publishedAt || v.snippet?.publishedAt);
      const thumb =
        v.thumbnailUrl ||
        v.thumbnails?.medium?.url ||
        v.snippet?.thumbnails?.medium?.url ||
        v.snippet?.thumbnails?.high?.url ||
        "";

      return `
        <div class="vcard">
          <div class="vthumb">
            <img src="${thumb}" alt="${title}">
            <button class="vplay" onclick="openYtModal('${vid}')">
              <span>â–¶</span>
            </button>
          </div>
          <div class="vmeta">
            <div class="vtitle">${title}</div>
            <div class="vsub">
              <div class="ch">${ch}</div>
              <div class="date">${dt}</div>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  loadVideos();
</script>
</body>
</html>
