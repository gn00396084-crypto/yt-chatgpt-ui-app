<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ÊïÖ‰∫ãË™™Èü≥Ê®ÇÔΩúYouTube Finder</title>
    <style>
      :root {
        --bg: #ffffff;
        --card: #ffffff;
        --text: #111111;
        --muted: rgba(0, 0, 0, 0.62);
        --border: rgba(0, 0, 0, 0.12);
        --chip: rgba(0, 0, 0, 0.06);
        --btn: #111111;
        --btnText: #ffffff;
        --btnGhost: #ffffff;
        --btnGhostText: #111111;
        --radius: 14px;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Noto Sans", "PingFang TC", "Microsoft JhengHei";
        background: var(--bg);
        color: var(--text);
      }

      .wrap {
        padding: 14px;
        max-width: 1160px;
        margin: 0 auto;
      }

      .top {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .brand {
        display: flex;
        gap: 8px;
        align-items: center;
        min-width: 240px;
      }

      .brand .icon {
        width: 28px;
        height: 28px;
        border-radius: 9px;
        display: grid;
        place-items: center;
        background: var(--chip);
        border: 1px solid var(--border);
        user-select: none;
      }

      .brand .title {
        font-size: 14px;
        font-weight: 700;
      }

      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .sep {
        width: 1px;
        height: 28px;
        background: var(--border);
        margin: 0 4px;
      }

      input[type="search"] {
        height: 34px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--text);
        outline: none;
        min-width: 220px;
      }

      button {
        height: 34px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--btnGhost);
        color: var(--btnGhostText);
        cursor: pointer;
      }

      button.primary {
        background: var(--btn);
        border-color: var(--btn);
        color: var(--btnText);
      }

      button:hover {
        filter: brightness(0.98);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }

      @media (min-width: 980px) {
        .grid {
          grid-template-columns: 1.12fr 0.88fr;
          align-items: start;
        }
        .detail {
          position: sticky;
          top: 12px;
        }
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
      }

      .meta {
        font-size: 12px;
        color: var(--muted);
        margin: 2px 0 10px;
      }

      .list {
        display: grid;
        gap: 10px;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        overflow: hidden;
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 10px;
        background: #fff;
      }

      .thumbWrap {
        width: 160px;
        aspect-ratio: 16 / 9;
        background: #f2f2f2;
        overflow: hidden;
      }

      .thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .content {
        padding: 10px 10px 10px 0;
        min-width: 0;
      }

      .h {
        font-size: 13px;
        font-weight: 700;
        line-height: 1.35;
        margin: 0 0 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .hbtn {
        all: unset;
        cursor: pointer;
        color: #0b57d0;
        text-decoration: underline;
        text-underline-offset: 2px;
        display: inline;
      }

      .sub {
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 8px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      a.inline {
        color: #0b57d0;
        text-decoration: none;
      }

      a.inline:hover {
        text-decoration: underline;
      }

      .chips {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .chip {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        color: rgba(0, 0, 0, 0.78);
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .pager {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      .status {
        font-size: 12px;
        color: var(--muted);
        margin-top: 10px;
        min-height: 16px;
      }

      .detailHead {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 8px;
      }

      .detailTitle {
        font-size: 13px;
        font-weight: 800;
      }

      .detailEmpty {
        font-size: 12px;
        color: var(--muted);
        padding: 8px 0;
      }

      .detailThumbWrap {
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 12px;
        overflow: hidden;
        background: #f2f2f2;
        border: 1px solid var(--border);
      }

      .detailBody h3 {
        margin: 10px 0 6px;
        font-size: 14px;
        line-height: 1.35;
      }

      .detailMeta {
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      .desc {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.82);
        white-space: pre-wrap;
        line-height: 1.5;
        border-top: 1px dashed var(--border);
        padding-top: 10px;
      }

      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        color: var(--muted);
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <div class="icon">üéß</div>
          <div class="title" id="channelTitle">YouTube Finder</div>
        </div>
        <div class="controls">
          <input id="q" type="search" placeholder="Ëº∏ÂÖ•ÈóúÈçµÂ≠óÔºàtitle/desc/tagsÔºâ" />
          <button class="primary" id="btnSearch">ÊêúÂ∞ã</button>
          <button id="btnLatest">Êñ∞Ê≠å</button>
          <button id="btnReset">Ê∏ÖÂñÆ</button>
          <span class="sep" aria-hidden="true"></span>
          <button id="btnFullscreen" title="Ë¶ÅÊ±ÇÂÖ®Ëû¢Âπï">ÂÖ®Ëû¢Âπï</button>
          <button id="btnPiP" title="Ë¶ÅÊ±Ç PiP">PiP</button>
          <button id="btnInline" title="ÂõûÂà∞ inline">Âõû inline</button>
        </div>
      </div>

      <div class="grid">
        <div class="panel">
          <div class="meta" id="meta"></div>
          <div class="list" id="list"></div>

          <div class="pager">
            <button id="btnPrev" disabled>‰∏ä‰∏ÄÈ†Å</button>
            <button id="btnNext" disabled>‰∏ã‰∏ÄÈ†Å</button>
          </div>

          <div class="status" id="status"></div>
        </div>

        <aside class="panel detail" id="detail">
          <div class="detailHead">
            <div class="detailTitle">ÂΩ±ÁâáË©≥ÊÉÖ</div>
            <button id="btnClear" title="Ê∏ÖÈô§ÈÅ∏Âèñ" style="display:none">Ê∏ÖÈô§</button>
          </div>
          <div class="detailBody" id="detailBody"></div>
          <div class="mono" id="debug"></div>
        </aside>
      </div>
    </div>

    <script>
      const host = window.openai;
      const $ = (id) => document.getElementById(id);

      const els = {
        channelTitle: $("channelTitle"),
        meta: $("meta"),
        list: $("list"),
        status: $("status"),
        q: $("q"),
        btnSearch: $("btnSearch"),
        btnLatest: $("btnLatest"),
        btnReset: $("btnReset"),
        btnFullscreen: $("btnFullscreen"),
        btnPiP: $("btnPiP"),
        btnInline: $("btnInline"),
        btnPrev: $("btnPrev"),
        btnNext: $("btnNext"),
        detailBody: $("detailBody"),
        btnClear: $("btnClear"),
        debug: $("debug"),
      };

      let state = {
        mode: "list_videos",
        q: "",
        cursor: 0,
        pageSize: 3,
        nextCursor: null,
        total: null,
        totalMatches: null,
        items: [],
        selected: null,
      };

      const esc = (s = "") =>
        String(s).replace(/[&<>"']/g, (c) =>
          ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c])
        );

      const fmtDate = (iso) => {
        if (!iso) return "";
        try { return new Date(iso).toISOString().slice(0, 10); } catch { return ""; }
      };

      const setStatus = (t = "") => (els.status.textContent = t);

      function getPersistedSelected() {
        const s = host?.widgetState?.selected;
        return s?.videoId ? s : null;
      }

      async function persistSelected(videoOrNull) {
        if (!host?.setWidgetState) return;
        const s =
          videoOrNull?.videoId
            ? {
                videoId: videoOrNull.videoId,
                title: videoOrNull.title || "",
                url: videoOrNull.url || "",
                thumbnailUrl: videoOrNull.thumbnailUrl || "",
                publishedAt: videoOrNull.publishedAt || "",
                descriptionSnippet: (videoOrNull.description || "").slice(0, 480),
              }
            : null;
        try { await host.setWidgetState({ selected: s }); } catch {}
      }

      async function openExternal(url) {
        if (!url) return;
        try {
          if (host?.openExternal) await host.openExternal({ href: url });
          else window.open(url, "_blank", "noopener,noreferrer");
        } catch (err) {
          setStatus("ÊâìÈñãÈÄ£ÁµêÂ§±ÊïóÔºö" + (err?.message || String(err)));
        }
      }

      async function requestMode(mode) {
        if (!mode) return;
        try { await host?.requestDisplayMode?.({ mode }); }
        catch (err) { setStatus("ÂàáÊèõÈ°ØÁ§∫Ê®°ÂºèÂ§±ÊïóÔºö" + (err?.message || String(err))); }
      }

      function renderDetail() {
        const persisted = getPersistedSelected();
        const selected = state.selected || persisted;

        if (!selected) {
          els.btnClear.style.display = "none";
          els.detailBody.innerHTML =
            `<div class="detailEmpty">ÈªûÈÅ∏Â∑¶ÈÇäÂΩ±ÁâáÊ®ôÈ°åÔºåÂç≥ÂèØÂú®Âè≥ÂÅ¥Êü•ÁúãÔºö<b>Ê®ôÈ°å + Ë™™ÊòéÂÖßÂÆπ</b>„ÄÇ</div>`;
          return;
        }

        els.btnClear.style.display = "inline-block";
        const thumb =
          selected.thumbnailUrl ||
          (selected.videoId ? `https://i.ytimg.com/vi/${encodeURIComponent(selected.videoId)}/hqdefault.jpg` : "");
        const title = selected.title || "";
        const date = fmtDate(selected.publishedAt);
        const url = selected.url || "";
        let desc = selected.description || "";
        if (!desc && selected.descriptionSnippet) desc = selected.descriptionSnippet;

        els.detailBody.innerHTML = `
          <div class="detailThumbWrap">
            <img class="thumb" src="${esc(thumb)}" alt="" referrerpolicy="no-referrer" />
          </div>
          <h3>${esc(title)}</h3>
          <div class="detailMeta">
            <span>‰∏äÊû∂Ôºö${esc(date || "-")}</span>
            <a class="inline" href="#" data-open="${esc(url)}">ÊâìÈñã YouTube</a>
          </div>
          <div class="desc">${esc(desc || "ÔºàÊ≤íÊúâË™™ÊòéÂÖßÂÆπÔºâ")}</div>
        `;

        els.detailBody.querySelector("a[data-open]")?.addEventListener("click", (e) => {
          e.preventDefault();
          openExternal(url);
        });
      }

      function renderList() {
        const items = state.items || [];
        els.btnPrev.disabled = state.cursor <= 0;
        els.btnNext.disabled = state.nextCursor == null;

        if (!items.length) {
          els.list.innerHTML = `<div class="meta">ÔºàÊ≤íÊúâË≥áÊñôÔºâ</div>`;
          return;
        }

        els.list.innerHTML = items.map((v) => {
          const thumb = v.thumbnailUrl || (v.videoId ? `https://i.ytimg.com/vi/${encodeURIComponent(v.videoId)}/hqdefault.jpg` : "");
          const tags = Array.isArray(v.tags) ? v.tags.slice(0, 8) : [];
          const date = fmtDate(v.publishedAt);
          return `
            <div class="card" data-id="${esc(v.videoId || "")}">
              <div class="thumbWrap">
                <img class="thumb" src="${esc(thumb)}" alt="" referrerpolicy="no-referrer" />
              </div>
              <div class="content">
                <div class="h">
                  <button class="hbtn js-select" type="button" data-id="${esc(v.videoId || "")}">${esc(v.title || "")}</button>
                </div>
                <div class="sub">
                  <span>‰∏äÊû∂Ôºö${esc(date)}</span>
                  <span>ÔΩú</span>
                  <a class="inline js-open" href="#" data-url="${esc(v.url || "")}">ÊâìÈñã YouTube</a>
                </div>
                <div class="chips">${tags.map((t) => `<span class="chip">${esc(t)}</span>`).join("")}</div>
              </div>
            </div>
          `;
        }).join("");

        els.list.querySelectorAll(".js-open").forEach((a) => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            openExternal(a.getAttribute("data-url"));
          });
        });

        const selectById = async (id) => {
          const v = (state.items || []).find((x) => (x.videoId || "") === id);
          if (!v) return;
          state.selected = v;
          await persistSelected(v);
          renderDetail();
        };

        els.list.querySelectorAll(".js-select").forEach((b) => {
          b.addEventListener("click", () => selectById(b.getAttribute("data-id")));
        });

        els.list.querySelectorAll(".thumbWrap").forEach((tw) => {
          tw.addEventListener("click", () => {
            const id = tw.closest(".card")?.getAttribute("data-id");
            selectById(id);
          });
        });
      }

      function render(payload) {
        if (!payload) return;
        const items = payload.items || (payload.item ? [payload.item] : []);

        state = {
          ...state,
          mode: payload.mode ?? state.mode,
          q: payload.q ?? state.q,
          cursor: Number(payload.cursor ?? state.cursor ?? 0),
          nextCursor: payload.nextCursor ?? null,
          pageSize: Number(payload.pageSize ?? state.pageSize ?? 3),
          total: payload.total ?? state.total,
          totalMatches: payload.totalMatches ?? state.totalMatches,
          items,
        };

        els.channelTitle.textContent = payload.channelTitle || "YouTube Finder";

        if (state.mode === "search_videos")
          els.meta.innerHTML = `ÊêúÂ∞ãÔºö<b>${esc(state.q)}</b>„ÄÄÁµêÊûúÔºö${state.totalMatches ?? 0}`;
        else if (state.mode === "latest_song")
          els.meta.innerHTML = "ÊúÄÊñ∞‰∏ÄÈ¶ñ";
        else
          els.meta.innerHTML = `ÂΩ±ÁâáÁ∏ΩÊï∏Ôºö${state.total ?? "?"}`;

        els.debug.textContent = `displayMode: ${host?.displayMode || "?"} ¬∑ maxHeight: ${host?.maxHeight ?? "unknown"} ¬∑ pageSize: ${state.pageSize}`;

        renderList();

        const persisted = getPersistedSelected();
        if (persisted?.videoId) {
          const full = (state.items || []).find((x) => (x.videoId || "") === persisted.videoId);
          if (full) state.selected = full;
        }
        renderDetail();
      }

      async function callTool(name, args) {
        if (!host?.callTool) throw new Error("window.openai.callTool ‰∏çÂ≠òÂú®");
        setStatus(`ÂëºÂè´Â∑•ÂÖ∑Ôºö${name}...`);
        const out = await host.callTool(name, args || {});
        render(out?.structuredContent || out);
        setStatus("");
      }

      els.btnSearch.addEventListener("click", async () => {
        const q = els.q.value.trim();
        if (!q) return;
        try { await callTool("search_videos", { q, cursor: 0, pageSize: state.pageSize }); }
        catch (e) { setStatus(e?.message || String(e)); }
      });

      els.q.addEventListener("keydown", (e) => { if (e.key === "Enter") els.btnSearch.click(); });

      els.btnLatest.addEventListener("click", () => callTool("latest_song", {}));
      els.btnReset.addEventListener("click", () => callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" }));

      els.btnFullscreen?.addEventListener("click", () => requestMode("fullscreen"));
      els.btnPiP?.addEventListener("click", () => requestMode("pip"));
      els.btnInline?.addEventListener("click", () => requestMode("inline"));

      els.btnPrev.addEventListener("click", async () => {
        const prev = Math.max(0, state.cursor - state.pageSize);
        if (state.mode === "search_videos")
          await callTool("search_videos", { q: state.q, cursor: prev, pageSize: state.pageSize });
        else
          await callTool("list_videos", { cursor: prev, pageSize: state.pageSize, sort: "newest" });
      });

      els.btnNext.addEventListener("click", async () => {
        if (state.nextCursor == null) return;
        if (state.mode === "search_videos")
          await callTool("search_videos", { q: state.q, cursor: state.nextCursor, pageSize: state.pageSize });
        else
          await callTool("list_videos", { cursor: state.nextCursor, pageSize: state.pageSize, sort: "newest" });
      });

      els.btnClear.addEventListener("click", async () => {
        state.selected = null;
        await persistSelected(null);
        renderDetail();
      });

      (async () => {
        const payload = host?.toolOutput?.structuredContent || host?.toolOutput;
        if (payload?.items || payload?.item) render(payload);
        else await callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" });
      })();
    </script>
  </body>
</html>
