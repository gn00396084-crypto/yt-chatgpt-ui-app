<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Finder</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Noto Sans CJK TC", "Microsoft JhengHei", sans-serif; }
    body { margin: 0; }
    .app { padding: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .row input{
      flex:1; min-width: 220px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      outline: none;
    }
    .row button{
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      background: transparent;
      cursor: pointer;
    }
    .row button[disabled]{ opacity:.45; cursor:not-allowed; }
    .hint { margin-top: 8px; font-size: 12px; opacity: .7; line-height: 1.4; }
    .grid { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .card { border: 1px solid rgba(0,0,0,.12); border-radius: 16px; overflow: hidden; cursor: pointer; background: rgba(0,0,0,.02); }
    .thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; display:block; background:#eee; }
    .meta { padding: 10px; }
    .title { font-size: 14px; font-weight: 650; line-height: 1.25; }
    .sub { margin-top: 6px; font-size: 12px; opacity: .75; }
    .detail { display:flex; flex-direction: column; gap: 10px; }
    .detail .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .badge { display:inline-flex; padding: 4px 8px; border: 1px solid rgba(0,0,0,.15); border-radius: 999px; font-size: 12px; opacity:.8; }
    .err { color: #b00020; opacity: .95; }
  </style>
</head>
<body>
  <div id="app" class="app"></div>

  <script type="module">
    const ROOT = document.getElementById("app");
    const SET_GLOBALS_EVENT = "openai:set_globals";

    let state = {
      view: "list",         // "list" | "detail"
      mode: "LIST",         // "LIST" | "SEARCH"
      pageSize: 3,          // ✅ 預設 3 筆
      page: 1,
      query: "",
      selectedId: "",
      channelTitle: "",
      videos: [],
      total: 0,
      pageCount: 1,
      hasPrev: false,
      hasNext: false,
      snapshot: "",         // ✅ 快照 token（避免分頁時資料跳）
      status: ""
    };

    // restore persisted widgetState
    try {
      const ws = window.openai?.widgetState;
      if (ws) {
        state.view = ws.view || state.view;
        state.mode = ws.mode || state.mode;
        state.pageSize = Number.isFinite(ws.pageSize) ? Math.max(1, ws.pageSize) : state.pageSize;
        state.page = Number.isFinite(ws.page) ? Math.max(1, ws.page) : state.page;
        state.query = ws.query || state.query;
        state.selectedId = ws.selectedId || state.selectedId;
        state.snapshot = ws.snapshot || state.snapshot;
      }
    } catch {}

    function persistWidgetState() {
      try {
        window.openai?.setWidgetState?.({
          view: state.view,
          mode: state.mode,
          pageSize: state.pageSize,
          page: state.page,
          query: state.query,
          selectedId: state.selectedId,
          snapshot: state.snapshot
        });
      } catch {}
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openExternal(href) {
      if (window.openai?.openExternal) return window.openai.openExternal({ href });
      window.open(href, "_blank", "noopener,noreferrer");
    }

    function currentOffset() {
      const p = Math.max(1, Number(state.page || 1));
      const ps = Math.max(1, Number(state.pageSize || 1));
      return (p - 1) * ps;
    }

    function applyToolStructured(sc) {
      if (!sc) return;

      if (typeof sc.channelTitle === "string") state.channelTitle = sc.channelTitle;
      if (typeof sc.query === "string") state.query = sc.query;

      if (typeof sc.snapshot === "string") state.snapshot = sc.snapshot;

      if (Number.isFinite(sc.total)) state.total = sc.total;
      if (Number.isFinite(sc.limit)) state.pageSize = Math.max(1, sc.limit);

      if (Number.isFinite(sc.pageCount)) state.pageCount = Math.max(1, sc.pageCount);
      if (Number.isFinite(sc.page)) state.page = Math.max(1, sc.page);

      if (typeof sc.hasPrev === "boolean") state.hasPrev = sc.hasPrev;
      if (typeof sc.hasNext === "boolean") state.hasNext = sc.hasNext;

      if (Array.isArray(sc.videos)) state.videos = sc.videos;

      persistWidgetState();
    }

    async function callTool(name, args) {
      if (!window.openai?.callTool) {
        state.status = "此頁需在 ChatGPT Apps Widget 內運行（window.openai.callTool 不可用）";
        render();
        return null;
      }
      try {
        state.status = "載入中…";
        render();
        const r = await window.openai.callTool(name, args);
        if (r?.structuredContent) applyToolStructured(r.structuredContent);
        state.status = "";
        render();
        return r;
      } catch (e) {
        state.status = "載入失敗：" + String(e?.message || e);
        render();
        return null;
      }
    }

    function loadListPage() {
      return callTool("list_videos", {
        offset: currentOffset(),
        limit: state.pageSize,
        snapshot: state.snapshot || undefined
      });
    }

    function loadSearchPage() {
      const q = (state.query || "").trim();
      if (!q) return;
      return callTool("search_videos", {
        query: q,
        offset: currentOffset(),
        limit: state.pageSize,
        snapshot: state.snapshot || undefined
      });
    }

    function openDetail(videoId) {
      const v = (state.videos || []).find(x => x.videoId === videoId);
      if (!v) return;
      state.view = "detail";
      state.selectedId = videoId;
      persistWidgetState();
      render();
    }

    function backToList() {
      state.view = "list";
      state.selectedId = "";
      persistWidgetState();
      render();
    }

    function renderList() {
      const channel = state.channelTitle ? `・${state.channelTitle}` : "";
      const p = Math.max(1, Number(state.page || 1));
      const pc = Math.max(1, Number(state.pageCount || 1));
      const totalText = state.total ? `共 ${state.total} 筆` : "—";

      ROOT.innerHTML = `
        <div class="row">
          <input id="q" placeholder="輸入關鍵字（歌名 / 歌手 / 主題）" value="${escapeHtml(state.query || "")}" />
          <button id="btnSearch">搜尋</button>
          <button id="btnLatest">最新</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="btnPrev" ${state.hasPrev ? "" : "disabled"}>上一頁</button>
          <button id="btnNext" ${state.hasNext ? "" : "disabled"}>下一頁</button>
          <span class="badge">第 ${p} / ${pc} 頁</span>
          <span class="badge">${escapeHtml(totalText)}</span>
        </div>

        <div class="hint">
          <span class="badge">每頁 ${state.pageSize} 筆</span>
          <span class="badge">點卡片看詳情</span>
          ${channel}
        </div>

        ${state.status ? `<div class="hint ${state.status.includes("失敗") ? "err" : ""}">⏳ ${escapeHtml(state.status)}</div>` : ""}

        <div class="grid">
          ${(state.videos || []).map(v => `
            <div class="card" data-id="${escapeHtml(v.videoId)}">
              <img class="thumb" loading="lazy" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />
              <div class="meta">
                <div class="title">${escapeHtml(v.title || "")}</div>
                <div class="sub">${escapeHtml((v.publishedAt || "").slice(0,10) || "")}</div>
              </div>
            </div>
          `).join("")}
        </div>
      `.trim();

      // ✅ 最新：重置 snapshot 取新快照（避免舊快照）
      ROOT.querySelector("#btnLatest")?.addEventListener("click", () => {
        state.mode = "LIST";
        state.page = 1;
        state.snapshot = "";
        persistWidgetState();
        loadListPage();
      });

      // ✅ 搜尋：重置 snapshot（新搜尋就新快照）
      ROOT.querySelector("#btnSearch")?.addEventListener("click", () => {
        const q = ROOT.querySelector("#q")?.value?.trim();
        if (!q) return;
        state.mode = "SEARCH";
        state.page = 1;
        state.query = q;
        state.snapshot = "";
        persistWidgetState();
        loadSearchPage();
      });

      ROOT.querySelector("#q")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") ROOT.querySelector("#btnSearch")?.click();
      });

      ROOT.querySelector("#btnPrev")?.addEventListener("click", () => {
        if (!state.hasPrev) return;
        state.page = Math.max(1, state.page - 1);
        persistWidgetState();
        if (state.mode === "SEARCH") loadSearchPage();
        else loadListPage();
      });

      ROOT.querySelector("#btnNext")?.addEventListener("click", () => {
        if (!state.hasNext) return;
        state.page = state.page + 1;
        persistWidgetState();
        if (state.mode === "SEARCH") loadSearchPage();
        else loadListPage();
      });

      ROOT.querySelectorAll(".card").forEach(card => {
        card.addEventListener("click", () => openDetail(card.getAttribute("data-id")));
      });
    }

    function renderDetail() {
      const v = (state.videos || []).find(x => x.videoId === state.selectedId);
      if (!v) { backToList(); return; }

      ROOT.innerHTML = `
        <div class="detail">
          <div class="row">
            <button id="btnBack">← 返回</button>
            <span class="badge">${escapeHtml(v.videoId)}</span>
          </div>

          <img class="thumb" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />

          <div class="title">${escapeHtml(v.title || "")}</div>
          <div class="sub">${escapeHtml((v.channelTitle || state.channelTitle || "") + " " + (v.publishedAt || "").slice(0,10))}</div>

          <div class="actions">
            <button id="btnYT">在 YouTube 打開</button>
            <button id="btnShort">用 youtu.be 打開</button>
          </div>

          ${state.status ? `<div class="hint ${state.status.includes("失敗") ? "err" : ""}">⏳ ${escapeHtml(state.status)}</div>` : ""}
        </div>
      `.trim();

      ROOT.querySelector("#btnBack")?.addEventListener("click", backToList);
      ROOT.querySelector("#btnYT")?.addEventListener("click", () => openExternal(`https://www.youtube.com/watch?v=${v.videoId}`));
      ROOT.querySelector("#btnShort")?.addEventListener("click", () => openExternal(`https://youtu.be/${v.videoId}`));
    }

    function render() {
      if (state.view === "detail") renderDetail();
      else renderList();
    }

    window.addEventListener(SET_GLOBALS_EVENT, () => { render(); }, { passive: true });

    render();

    // 初次載入：如果有 snapshot（上次快照）就沿用，否則工具會回新 snapshot
    if (!state.videos?.length) {
      if (state.mode === "SEARCH" && (state.query || "").trim()) loadSearchPage();
      else loadListPage();
    }
  </script>
</body>
</html>
