<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>YouTube Finder</title>
    <style>
      :root {
        --bg: #0b0b0d;
        --card: #141419;
        --muted: rgba(255,255,255,.7);
        --border: rgba(255,255,255,.10);
        --chip: rgba(255,255,255,.08);<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>YouTube Finder</title>
    <style>
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#0b0b0d;color:#fff}
      .wrap{padding:14px}
      .top{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
      .title{font-size:14px;font-weight:650;opacity:.9}
      .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      input{height:34px;padding:0 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;outline:none;min-width:200px}
      button{height:34px;padding:0 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
      button:hover{background:rgba(255,255,255,.16)}
      button:disabled{opacity:.5;cursor:not-allowed}
      .meta{font-size:12px;color:rgba(255,255,255,.7);margin:8px 0 10px}
      .list{display:grid;gap:10px}
      .card{background:#141419;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;display:grid;grid-template-columns:150px 1fr;gap:10px}
      .thumb{width:150px;height:84px;object-fit:cover;background:#000}
      .content{padding:10px 10px 10px 0}
      .h{font-size:13px;font-weight:650;line-height:1.35;margin:0 0 6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
      .sub{font-size:12px;color:rgba(255,255,255,.7);margin:0 0 8px}
      .chips{display:flex;gap:6px;flex-wrap:wrap}
      .chip{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.08);color:rgba(255,255,255,.85);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
      .pager{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
      .status{font-size:12px;color:rgba(255,255,255,.7);margin-top:10px;min-height:16px}
      a.inline{color:#9fd3ff;text-decoration:none}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div class="title" id="channelTitle">YouTube Finder</div>
        <div class="controls">
          <input id="q" placeholder="輸入關鍵字（title/desc/tags）" />
          <button id="btnSearch">搜尋</button>
          <button id="btnLatest">新歌</button>
          <button id="btnReset">清單</button>
        </div>
      </div>

      <div class="meta" id="meta"></div>
      <div class="list" id="list"></div>

      <div class="pager">
        <button id="btnPrev" disabled>上一頁</button>
        <button id="btnNext" disabled>下一頁</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <script>
      const host = window.openai;
      const $ = (id) => document.getElementById(id);

      const els = {
        channelTitle: $("channelTitle"),
        meta: $("meta"),
        list: $("list"),
        status: $("status"),
        q: $("q"),
        btnSearch: $("btnSearch"),
        btnLatest: $("btnLatest"),
        btnReset: $("btnReset"),
        btnPrev: $("btnPrev"),
        btnNext: $("btnNext"),
      };

      let state = { mode:"list_videos", q:"", cursor:0, pageSize:3, nextCursor:null, total:null, totalMatches:null, items:[] };

      const esc = (s="") => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
      const fmtDate = (iso) => { try { return new Date(iso).toISOString().slice(0,10); } catch { return ""; } };
      const status = (t="") => els.status.textContent = t;

      function render(payload) {
        if (!payload) return;

        const items = payload.items || (payload.item ? [payload.item] : []);
        state = {
          ...state,
          mode: payload.mode ?? state.mode,
          q: payload.q ?? state.q,
          cursor: Number(payload.cursor ?? state.cursor ?? 0),
          nextCursor: payload.nextCursor ?? null,
          pageSize: Number(payload.pageSize ?? state.pageSize ?? 3),
          total: payload.total ?? state.total,
          totalMatches: payload.totalMatches ?? state.totalMatches,
          items
        };

        els.channelTitle.textContent = payload.channelTitle || "YouTube Finder";

        let meta = "";
        if (state.mode === "search_videos") meta = `搜尋：<b>${esc(state.q)}</b>　結果：${state.totalMatches ?? 0}`;
        else if (state.mode === "latest_song") meta = "最新一首";
        else meta = `影片總數：${state.total ?? "?"}`;
        els.meta.innerHTML = meta;

        els.btnPrev.disabled = state.cursor <= 0;
        els.btnNext.disabled = state.nextCursor == null;

        if (!items.length) {
          els.list.innerHTML = `<div class="meta">（沒有資料）</div>`;
          return;
        }

        els.list.innerHTML = items.map(v => {
          const thumb = v.thumbnailUrl || (v.videoId ? `https://i.ytimg.com/vi/${v.videoId}/hqdefault.jpg` : "");
          const tags = Array.isArray(v.tags) ? v.tags.slice(0,8) : [];
          const date = fmtDate(v.publishedAt);

          return `
            <div class="card">
              <img class="thumb" src="${esc(thumb)}" alt="" referrerpolicy="no-referrer" />
              <div class="content">
                <div class="h">${esc(v.title || "")}</div>
                <div class="sub">上架：${esc(date)}　｜　
                  <a class="inline" href="#" data-url="${esc(v.url || "")}">打開 YouTube</a>
                </div>
                <div class="chips">${tags.map(t=>`<span class="chip">${esc(t)}</span>`).join("")}</div>
              </div>
            </div>
          `;
        }).join("");

        els.list.querySelectorAll("a[data-url]").forEach(a => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const url = a.getAttribute("data-url");
            if (!url) return;
            try {
              if (host?.openExternal) await host.openExternal(url);
              else window.open(url, "_blank");
            } catch (err) {
              status("打開連結失敗：" + (err?.message || String(err)));
            }
          });
        });
      }

      async function callTool(name, args) {
        if (!host?.callTool) throw new Error("window.openai.callTool 不存在（請確認 skybridge 正常）");
        status(`呼叫工具：${name}...`);
        const out = await host.callTool(name, args || {});
        const payload = out?.structuredContent || out;
        render(payload);
        status("");
      }

      els.btnSearch.addEventListener("click", async () => {
        const q = els.q.value.trim();
        if (!q) return;
        try { await callTool("search_videos", { q, cursor: 0, pageSize: state.pageSize }); }
        catch (e) { status(e?.message || String(e)); }
      });

      els.q.addEventListener("keydown", (e) => { if (e.key === "Enter") els.btnSearch.click(); });

      els.btnLatest.addEventListener("click", async () => {
        try { await callTool("latest_song", {}); }
        catch (e) { status(e?.message || String(e)); }
      });

      els.btnReset.addEventListener("click", async () => {
        try { await callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" }); }
        catch (e) { status(e?.message || String(e)); }
      });

      els.btnPrev.addEventListener("click", async () => {
        const prev = Math.max(0, state.cursor - state.pageSize);
        try {
          if (state.mode === "search_videos") await callTool("search_videos", { q: state.q, cursor: prev, pageSize: state.pageSize });
          else await callTool("list_videos", { cursor: prev, pageSize: state.pageSize, sort: "newest" });
        } catch (e) { status(e?.message || String(e)); }
      });

      els.btnNext.addEventListener("click", async () => {
        if (state.nextCursor == null) return;
        try {
          if (state.mode === "search_videos") await callTool("search_videos", { q: state.q, cursor: state.nextCursor, pageSize: state.pageSize });
          else await callTool("list_videos", { cursor: state.nextCursor, pageSize: state.pageSize, sort: "newest" });
        } catch (e) { status(e?.message || String(e)); }
      });

      // 初次：若由 tool 觸發，host.toolOutput 可能已有資料
      try {
        const out = host?.toolOutput;
        const payload = out?.structuredContent || out;
        if (payload && (payload.items || payload.item)) render(payload);
        else callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" });
      } catch (e) {
        status(e?.message || String(e));
      }
    </script>
  </body>
</html>

        --btn: rgba(255,255,255,.10);
        --btnHover: rgba(255,255,255,.16);
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: var(--bg);
        color: #fff;
      }
      .wrap { padding: 14px; }
      .top {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .title {
        font-size: 14px;
        font-weight: 650;
        opacity: .9;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      input[type="search"]{
        height: 34px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255,255,255,.06);
        color: #fff;
        outline: none;
        min-width: 200px;
      }
      button {
        height: 34px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--btn);
        color: #fff;
        cursor: pointer;
      }
      button:hover { background: var(--btnHover); }
      button:disabled { opacity: .5; cursor: not-allowed; }
      .meta {
        font-size: 12px;
        color: var(--muted);
        margin: 8px 0 10px;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        overflow: hidden;
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 10px;
      }
      .thumb {
        width: 150px;
        height: 84px;
        object-fit: cover;
        background: #000;
      }
      .content { padding: 10px 10px 10px 0; }
      .h {
        font-size: 13px;
        font-weight: 650;
        line-height: 1.35;
        margin: 0 0 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .sub {
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 8px;
      }
      .chips { display: flex; gap: 6px; flex-wrap: wrap; }
      .chip {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        color: rgba(255,255,255,.85);
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .pager {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      .status {
        font-size: 12px;
        color: var(--muted);
        margin-top: 10px;
        min-height: 16px;
      }
      a.inline {
        color: #9fd3ff;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div class="title" id="channelTitle">YouTube Finder</div>
        <div class="controls">
          <input id="q" type="search" placeholder="輸入關鍵字（title/desc/tags）" />
          <button id="btnSearch">搜尋</button>
          <button id="btnLatest">新歌</button>
          <button id="btnReset">清單</button>
        </div>
      </div>

      <div class="meta" id="meta"></div>
      <div class="list" id="list"></div>

      <div class="pager">
        <button id="btnPrev" disabled>上一頁</button>
        <button id="btnNext" disabled>下一頁</button>
      </div>

      <div class="status" id="status"></div>
    </div>

    <script>
      const host = window.openai;

      const els = {
        channelTitle: document.getElementById("channelTitle"),
        meta: document.getElementById("meta"),
        list: document.getElementById("list"),
        status: document.getElementById("status"),
        q: document.getElementById("q"),
        btnSearch: document.getElementById("btnSearch"),
        btnLatest: document.getElementById("btnLatest"),
        btnReset: document.getElementById("btnReset"),
        btnPrev: document.getElementById("btnPrev"),
        btnNext: document.getElementById("btnNext"),
      };

      let state = {
        mode: "list_videos",
        q: "",
        cursor: 0,
        pageSize: 3,
        nextCursor: null,
        total: null,
        totalMatches: null,
        items: []
      };

      function setStatus(t) {
        els.status.textContent = t || "";
      }

      function escapeHtml(s) {
        return (s || "").replace(/[&<>"']/g, c => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
        }[c]));
      }

      function fmtDate(iso) {
        if (!iso) return "";
        try {
          const d = new Date(iso);
          return d.toISOString().slice(0, 10);
        } catch { return ""; }
      }

      function render(payload) {
        if (!payload) return;

        const channelTitle = payload.channelTitle || "YouTube Finder";
        els.channelTitle.textContent = channelTitle;

        // normalize payload
        const mode = payload.mode || state.mode;
        const cursor = Number(payload.cursor ?? state.cursor ?? 0);
        const nextCursor = payload.nextCursor ?? null;
        const pageSize = Number(payload.pageSize ?? state.pageSize ?? 3);

        const items = payload.items || (payload.item ? [payload.item] : []);
        const total = payload.total ?? null;
        const totalMatches = payload.totalMatches ?? null;
        const q = payload.q ?? state.q ?? "";

        state = { ...state, mode, cursor, nextCursor, pageSize, total, totalMatches, q, items };

        // meta line
        let meta = "";
        if (mode === "search_videos") {
          meta = `搜尋：<b>${escapeHtml(q)}</b>　結果：${totalMatches ?? 0}`;
        } else if (mode === "latest_song") {
          meta = "最新一首";
        } else {
          meta = `影片總數：${total ?? "?"}`;
        }
        els.meta.innerHTML = meta;

        // pager
        els.btnPrev.disabled = cursor <= 0;
        els.btnNext.disabled = nextCursor == null;

        // list
        if (!items.length) {
          els.list.innerHTML = `<div class="meta">（沒有資料）</div>`;
          return;
        }

        els.list.innerHTML = items.map(v => {
          const thumb = v.thumbnailUrl || (v.videoId ? `https://i.ytimg.com/vi/${v.videoId}/hqdefault.jpg` : "");
          const tags = Array.isArray(v.tags) ? v.tags.slice(0, 8) : [];
          const date = fmtDate(v.publishedAt);

          return `
            <div class="card">
              <img class="thumb" src="${escapeHtml(thumb)}" alt="" referrerpolicy="no-referrer" />
              <div class="content">
                <div class="h">${escapeHtml(v.title || "")}</div>
                <div class="sub">上架：${escapeHtml(date)}　｜　
                  <a class="inline" href="#" data-url="${escapeHtml(v.url || "")}">打開 YouTube</a>
                </div>
                <div class="chips">
                  ${tags.map(t => `<span class="chip">${escapeHtml(t)}</span>`).join("")}
                </div>
              </div>
            </div>
          `;
        }).join("");

        // bind openExternal
        els.list.querySelectorAll("a[data-url]").forEach(a => {
          a.addEventListener("click", async (e) => {
            e.preventDefault();
            const url = a.getAttribute("data-url");
            if (!url) return;
            try {
              if (host?.openExternal) await host.openExternal(url);
              else window.open(url, "_blank");
            } catch (err) {
              setStatus("打開連結失敗：" + (err?.message || String(err)));
            }
          });
        });
      }

      async function callTool(name, args) {
        if (!host?.callTool) throw new Error("window.openai.callTool 不存在（請確認 widget 以 skybridge 載入）");
        setStatus(`呼叫工具：${name} ...`);
        const out = await host.callTool(name, args || {});
        // callTool 回傳格式可能係 { structuredContent, content } 或直接 structuredContent
        const payload = out?.structuredContent || out;
        render(payload);
        setStatus("");
      }

      // Buttons
      els.btnSearch.addEventListener("click", async () => {
        const q = els.q.value.trim();
        if (!q) return;
        try {
          await callTool("search_videos", { q, cursor: 0, pageSize: state.pageSize });
        } catch (e) { setStatus(e?.message || String(e)); }
      });

      els.q.addEventListener("keydown", (e) => {
        if (e.key === "Enter") els.btnSearch.click();
      });

      els.btnLatest.addEventListener("click", async () => {
        try {
          await callTool("latest_song", {});
        } catch (e) { setStatus(e?.message || String(e)); }
      });

      els.btnReset.addEventListener("click", async () => {
        try {
          await callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" });
        } catch (e) { setStatus(e?.message || String(e)); }
      });

      els.btnPrev.addEventListener("click", async () => {
        const prev = Math.max(0, (state.cursor || 0) - (state.pageSize || 3));
        try {
          if (state.mode === "search_videos") {
            await callTool("search_videos", { q: state.q, cursor: prev, pageSize: state.pageSize });
          } else {
            await callTool("list_videos", { cursor: prev, pageSize: state.pageSize, sort: "newest" });
          }
        } catch (e) { setStatus(e?.message || String(e)); }
      });

      els.btnNext.addEventListener("click", async () => {
        if (state.nextCursor == null) return;
        try {
          if (state.mode === "search_videos") {
            await callTool("search_videos", { q: state.q, cursor: state.nextCursor, pageSize: state.pageSize });
          } else {
            await callTool("list_videos", { cursor: state.nextCursor, pageSize: state.pageSize, sort: "newest" });
          }
        } catch (e) { setStatus(e?.message || String(e)); }
      });

      // 初次渲染：先嘗試讀 host.toolOutput（如果係由對話工具觸發，通常會有）
      function initFromHostOutput() {
        try {
          const out = host?.toolOutput;
          const payload = out?.structuredContent || out;
          if (payload && (payload.items || payload.item)) {
            render(payload);
            return true;
          }
        } catch {}
        return false;
      }

      // 兼容：如果 host toolOutput 後續才更新，用輕量輪詢更新一次
      let lastSig = "";
      setInterval(() => {
        try {
          const out = host?.toolOutput;
          const sig = JSON.stringify(out || null);
          if (sig && sig !== lastSig) {
            lastSig = sig;
            const payload = out?.structuredContent || out;
            if (payload && (payload.items || payload.item)) render(payload);
          }
        } catch {}
      }, 600);

      (async function boot() {
        const ok = initFromHostOutput();
        if (!ok) {
          try {
            await callTool("list_videos", { cursor: 0, pageSize: state.pageSize, sort: "newest" });
          } catch (e) {
            setStatus(e?.message || String(e));
          }
        }
      })();
    </script>
  </body>
</html>
