<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Finder</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Noto Sans CJK TC", "Microsoft JhengHei", sans-serif; }
    body { margin: 0; }
    .app { padding: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .row input{
      flex:1; min-width: 220px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      outline: none;
    }
    .row button{
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      background: transparent;
      cursor: pointer;
    }
    .hint { margin-top: 8px; font-size: 12px; opacity: .7; line-height: 1.4; }
    .grid { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .card {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      background: rgba(0,0,0,.02);
    }
    .thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; display:block; background:#eee; }
    .meta { padding: 10px; }
    .title { font-size: 14px; font-weight: 650; line-height: 1.25; }
    .sub { margin-top: 6px; font-size: 12px; opacity: .75; }
    .detail { display:flex; flex-direction: column; gap: 10px; }
    .detail .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .badge { display:inline-flex; padding: 4px 8px; border: 1px solid rgba(0,0,0,.15); border-radius: 999px; font-size: 12px; opacity:.8; }
    .err { color: #b00020; opacity: .95; }
  </style>
</head>
<body>
  <div id="app" class="app"></div>

  <script type="module">
    const ROOT = document.getElementById("app");
    const SET_GLOBALS_EVENT = "openai:set_globals";

    // ---------- state ----------
    let state = {
      view: "list",     // "list" | "detail"
      query: "",
      selectedId: "",
      channelTitle: "",
      videos: [],
      status: ""
    };

    // restore persisted widgetState if exists
    try {
      if (window.openai?.widgetState) {
        const ws = window.openai.widgetState;
        state.view = ws.view || state.view;
        state.query = ws.query || state.query;
        state.selectedId = ws.selectedId || state.selectedId;
      }
    } catch {}

    function persistWidgetState() {
      try {
        window.openai?.setWidgetState?.({
          view: state.view,
          query: state.query,
          selectedId: state.selectedId
        });
      } catch {}
    }

    // ---------- helpers ----------
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openExternal(href) {
      if (window.openai?.openExternal) return window.openai.openExternal({ href });
      window.open(href, "_blank", "noopener,noreferrer");
    }

    function applyToolStructured(structuredContent) {
      if (!structuredContent) return;
      if (typeof structuredContent.channelTitle === "string") state.channelTitle = structuredContent.channelTitle;
      if (typeof structuredContent.query === "string") state.query = structuredContent.query;
      if (Array.isArray(structuredContent.videos)) state.videos = structuredContent.videos;
    }

    async function callTool(name, args) {
      if (!window.openai?.callTool) {
        state.status = "此頁需在 ChatGPT Apps Widget 內運行（window.openai.callTool 不可用）";
        render();
        return null;
      }
      try {
        state.status = "載入中…";
        render();
        const r = await window.openai.callTool(name, args);
        if (r?.structuredContent) applyToolStructured(r.structuredContent);
        state.status = "";
        render();
        return r;
      } catch (e) {
        state.status = "載入失敗：" + String(e?.message || e);
        render();
        return null;
      }
    }

    function openDetail(videoId) {
      const v = (state.videos || []).find(x => x.videoId === videoId);
      if (!v) return;
      state.view = "detail";
      state.selectedId = videoId;
      persistWidgetState();
      render();
    }

    function backToList() {
      state.view = "list";
      state.selectedId = "";
      persistWidgetState();
      render();
    }

    // ---------- render ----------
    function renderList() {
      const channel = state.channelTitle ? `・${state.channelTitle}` : "";
      ROOT.innerHTML = `
        <div class="row">
          <input id="q" placeholder="輸入關鍵字（歌名 / 歌手 / 主題）" value="${escapeHtml(state.query || "")}" />
          <button id="btnSearch">搜尋</button>
          <button id="btnLatest">最新</button>
        </div>

        <div class="hint">
          <span class="badge">點卡片看詳情</span>
          <span class="badge">外部連結用 openExternal</span>
          ${channel}
        </div>

        ${state.status ? `<div class="hint ${state.status.includes("失敗") ? "err" : ""}">⏳ ${escapeHtml(state.status)}</div>` : ""}

        <div class="grid">
          ${(state.videos || []).map(v => `
            <div class="card" data-id="${escapeHtml(v.videoId)}">
              <img class="thumb" loading="lazy" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />
              <div class="meta">
                <div class="title">${escapeHtml(v.title || "")}</div>
                <div class="sub">${escapeHtml((v.publishedAt || "").slice(0,10) || "")}</div>
              </div>
            </div>
          `).join("")}
        </div>
      `.trim();

      ROOT.querySelector("#btnLatest")?.addEventListener("click", () => callTool("list_videos", { limit: 30 }));

      ROOT.querySelector("#btnSearch")?.addEventListener("click", () => {
        const q = ROOT.querySelector("#q")?.value?.trim();
        if (!q) return;
        state.query = q;
        persistWidgetState();
        callTool("search_videos", { query: q, limit: 30 });
      });

      ROOT.querySelector("#q")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") ROOT.querySelector("#btnSearch")?.click();
      });

      ROOT.querySelectorAll(".card").forEach(card => {
        card.addEventListener("click", () => openDetail(card.getAttribute("data-id")));
      });
    }

    function renderDetail() {
      const v = (state.videos || []).find(x => x.videoId === state.selectedId);
      if (!v) { backToList(); return; }

      ROOT.innerHTML = `
        <div class="detail">
          <div class="row">
            <button id="btnBack">← 返回</button>
            <span class="badge">${escapeHtml(v.videoId)}</span>
          </div>

          <img class="thumb" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />

          <div class="title">${escapeHtml(v.title || "")}</div>
          <div class="sub">${escapeHtml((v.channelTitle || state.channelTitle || "") + " " + (v.publishedAt || "").slice(0,10))}</div>

          <div class="actions">
            <button id="btnYT">在 YouTube 打開</button>
            <button id="btnShort">用 youtu.be 打開</button>
          </div>

          ${state.status ? `<div class="hint ${state.status.includes("失敗") ? "err" : ""}">⏳ ${escapeHtml(state.status)}</div>` : ""}
        </div>
      `.trim();

      ROOT.querySelector("#btnBack")?.addEventListener("click", backToList);
      ROOT.querySelector("#btnYT")?.addEventListener("click", () => openExternal(`https://www.youtube.com/watch?v=${v.videoId}`));
      ROOT.querySelector("#btnShort")?.addEventListener("click", () => openExternal(`https://youtu.be/${v.videoId}`));
    }

    function render() {
      if (state.view === "detail") renderDetail();
      else renderList();
    }

    // host globals updated event
    window.addEventListener(SET_GLOBALS_EVENT, () => {
      // 注意：不要每次 render 都 sync toolOutput；避免入口工具的 toolOutput 造成覆蓋
      render();
    }, { passive: true });

    // first paint
    render();

    // auto load latest if empty
    if (!state.videos?.length) {
      callTool("list_videos", { limit: 30 });
    }
  </script>
</body>
</html>
