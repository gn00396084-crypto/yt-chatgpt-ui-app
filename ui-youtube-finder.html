<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Finder</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang TC", "Noto Sans CJK TC", "Microsoft JhengHei", sans-serif; }
    body { margin: 0; }
    .app { padding: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .row input{
      flex:1; min-width: 220px;
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      outline: none;
    }
    .row button{
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,.18);
      border-radius: 12px;
      background: transparent;
      cursor: pointer;
    }
    .hint { margin-top: 8px; font-size: 12px; opacity: .7; }
    .grid { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .card {
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      background: rgba(0,0,0,.02);
    }
    .thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; display:block; background:#eee; }
    .meta { padding: 10px; }
    .title { font-size: 14px; font-weight: 650; line-height: 1.25; }
    .sub { margin-top: 6px; font-size: 12px; opacity: .75; }
    .detail { display:flex; flex-direction: column; gap: 10px; }
    .detail .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .badge { display:inline-flex; padding: 4px 8px; border: 1px solid rgba(0,0,0,.15); border-radius: 999px; font-size: 12px; opacity:.8; }
  </style>
</head>
<body>
  <div id="app" class="app"></div>

  <script type="module">
    const ROOT = document.getElementById("app");
    const SET_GLOBALS_EVENT = "openai:set_globals";

    function safe(obj, fallback) { return obj == null ? fallback : obj; }

    function loadPersisted() {
      return safe(window.openai?.widgetState, {});
    }
    function persist(patch) {
      const next = { ...state, ...patch };
      state = next;
      window.openai?.setWidgetState?.({
        view: state.view,
        query: state.query,
        selectedId: state.selectedId,
      });
    }

    let state = {
      view: "list",        // "list" | "detail"
      query: "",
      selectedId: "",
      channelTitle: "",
      videos: [],
      status: "",
      ...loadPersisted(),
    };

    function syncFromToolOutput() {
      const out = window.openai?.toolOutput;
      if (!out) return;
      if (typeof out.channelTitle === "string") state.channelTitle = out.channelTitle;
      if (typeof out.query === "string") state.query = out.query;
      if (Array.isArray(out.videos)) state.videos = out.videos;
    }

    async function call(name, args) {
      if (!window.openai?.callTool) {
        state.status = "window.openai.callTool 不可用（請檢查 tool 是否設了 openai/widgetAccessible）";
        render();
        return null;
      }
      try {
        state.status = "載入中…";
        render();
        const r = await window.openai.callTool(name, args);
        // 兼容：有些 runtime 會直接回傳 structuredContent；同時 host 亦可能會更新 toolOutput
        if (r?.structuredContent) {
          state.channelTitle = r.structuredContent.channelTitle ?? state.channelTitle;
          state.query = r.structuredContent.query ?? state.query;
          state.videos = r.structuredContent.videos ?? state.videos;
        } else {
          syncFromToolOutput();
        }
        state.status = "";
        render();
        return r;
      } catch (e) {
        state.status = "載入失敗：" + String(e?.message || e);
        render();
        return null;
      }
    }

    function openExternal(href) {
      if (window.openai?.openExternal) return window.openai.openExternal({ href });
      window.open(href, "_blank", "noopener,noreferrer");
    }

    function openDetail(videoId) {
      const v = (state.videos || []).find(x => x.videoId === videoId);
      if (!v) return;
      persist({ view: "detail", selectedId: videoId });
      render();
    }
    function backToList() {
      persist({ view: "list", selectedId: "" });
      render();
    }

    function renderList() {
      const channel = state.channelTitle ? `・${state.channelTitle}` : "";
      ROOT.innerHTML = `
        <div class="row">
          <input id="q" placeholder="輸入關鍵字（歌名 / 歌手 / 主題）" value="${escapeHtml(state.query || "")}" />
          <button id="btnSearch">搜尋</button>
          <button id="btnLatest">最新</button>
        </div>
        <div class="hint">
          <span class="badge">縮圖：i.ytimg.com</span>
          <span class="badge">點卡片開詳情</span>
          <span class="badge">開外部連結用 openExternal</span>
          ${channel}
        </div>
        ${state.status ? `<div class="hint">⏳ ${escapeHtml(state.status)}</div>` : ""}
        <div class="grid">
          ${(state.videos || []).map(v => `
            <div class="card" data-id="${escapeHtml(v.videoId)}">
              <img class="thumb" loading="lazy" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />
              <div class="meta">
                <div class="title">${escapeHtml(v.title || "")}</div>
                <div class="sub">${escapeHtml((v.publishedAt || "").slice(0,10) || "")}</div>
              </div>
            </div>
          `).join("")}
        </div>
      `.trim();

      ROOT.querySelector("#btnLatest")?.addEventListener("click", () => call("list_videos", { limit: 30 }));
      ROOT.querySelector("#btnSearch")?.addEventListener("click", () => {
        const q = ROOT.querySelector("#q")?.value?.trim();
        if (!q) return;
        persist({ query: q });
        call("search_videos", { query: q, limit: 30 });
      });
      ROOT.querySelector("#q")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") ROOT.querySelector("#btnSearch")?.click();
      });
      ROOT.querySelectorAll(".card").forEach(card => {
        card.addEventListener("click", () => openDetail(card.getAttribute("data-id")));
      });
    }

    function renderDetail() {
      const v = (state.videos || []).find(x => x.videoId === state.selectedId);
      if (!v) { backToList(); return; }

      ROOT.innerHTML = `
        <div class="detail">
          <div class="row">
            <button id="btnBack">← 返回</button>
            <span class="badge">${escapeHtml(v.videoId)}</span>
          </div>
          <img class="thumb" src="${escapeHtml(v.thumbnailUrl || "")}" alt="" />
          <div class="title">${escapeHtml(v.title || "")}</div>
          <div class="sub">${escapeHtml((v.channelTitle || state.channelTitle || "") + " " + (v.publishedAt || "").slice(0,10))}</div>
          <div class="actions">
            <button id="btnYT">在 YouTube 打開</button>
            <button id="btnShort">用 youtu.be 打開</button>
          </div>
          ${state.status ? `<div class="hint">⏳ ${escapeHtml(state.status)}</div>` : ""}
        </div>
      `.trim();

      ROOT.querySelector("#btnBack")?.addEventListener("click", backToList);
      ROOT.querySelector("#btnYT")?.addEventListener("click", () => openExternal(`https://www.youtube.com/watch?v=${v.videoId}`));
      ROOT.querySelector("#btnShort")?.addEventListener("click", () => openExternal(`https://youtu.be/${v.videoId}`));
    }

    function render() {
      syncFromToolOutput();
      if (state.view === "detail") renderDetail();
      else renderList();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    window.addEventListener(SET_GLOBALS_EVENT, () => { syncFromToolOutput(); render(); }, { passive: true });

    // 初次 render
    render();

    // 如果係「開 app」但未有資料，就自動拉最新
    if (!state.videos?.length) {
      call("list_videos", { limit: 30 });
    }
  </script>
</body>
</html>
